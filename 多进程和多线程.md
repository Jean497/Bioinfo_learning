## **ğŸš€ Python çº¿ç¨‹ä¸è¿›ç¨‹å¹¶è¡Œè®¡ç®—è¯¦è§£**

### **1ï¸âƒ£ GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ**
Python çš„ **GILï¼ˆGlobal Interpreter Lockï¼Œå…¨å±€è§£é‡Šå™¨é”ï¼‰** é™åˆ¶äº†åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ Python å­—èŠ‚ç ã€‚

ğŸ”¹ **å½±å“ï¼š**
- çº¿ç¨‹ä¸èƒ½çœŸæ­£å¹¶è¡Œæ‰§è¡Œ CPU å¯†é›†ä»»åŠ¡ï¼ˆå› ä¸º GIL åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ Python ä»£ç ï¼‰ã€‚
- é€‚ç”¨äº I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ï¼‰ï¼Œå› ä¸º GIL é‡Šæ”¾æ—¶ I/O çº¿ç¨‹å¯ç»§ç»­æ‰§è¡Œã€‚

ğŸ”¹ **å¦‚ä½•ç»•è¿‡ GILï¼Ÿ**
- **ä½¿ç”¨ `ProcessPoolExecutor`**ï¼ˆæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ GILï¼Œå¯çœŸæ­£å¹¶è¡Œï¼‰ã€‚
- **ä½¿ç”¨ C æ‰©å±•åº“**ï¼ˆå¦‚ NumPyï¼Œå†…éƒ¨é‡Šæ”¾ GIL è¿›è¡Œå¤šçº¿ç¨‹è®¡ç®—ï¼‰ã€‚

---

### **2ï¸âƒ£ ProcessPoolExecutor vs. ThreadPoolExecutor**
| ç‰¹æ€§ | `ProcessPoolExecutor` | `ThreadPoolExecutor` |
|---|---|---|
| é€‚ç”¨ä»»åŠ¡ | CPU å¯†é›†ï¼ˆè®¡ç®—ï¼‰ | I/O å¯†é›†ï¼ˆæ–‡ä»¶ã€ç½‘ç»œï¼‰ |
| èµ„æºåˆ©ç”¨ | å¤šä¸ª CPU æ ¸å¿ƒï¼ˆç»•è¿‡ GILï¼‰ | å…±äº« CPU æ ¸å¿ƒï¼ˆå— GIL é™åˆ¶ï¼‰ |
| è¿›ç¨‹/çº¿ç¨‹ | å¤šè¿›ç¨‹ï¼ˆç‹¬ç«‹å†…å­˜ï¼‰ | å¤šçº¿ç¨‹ï¼ˆå…±äº«å†…å­˜ï¼‰ |
| è¿›ç¨‹/çº¿ç¨‹å¯åŠ¨å¼€é”€ | é«˜ï¼ˆåˆ›å»ºè¿›ç¨‹è¾ƒæ…¢ï¼‰ | ä½ï¼ˆåˆ›å»ºçº¿ç¨‹å¿«ï¼‰ |
| å†…å­˜å ç”¨ | é«˜ï¼ˆæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹ï¼‰ | ä½ï¼ˆå…±äº«å†…å­˜ï¼‰ |
| é€‚åˆçš„ä»»åŠ¡ç¤ºä¾‹ | å¤§è§„æ¨¡è®¡ç®—ã€å›¾åƒå¤„ç† | ç½‘ç»œçˆ¬è™«ã€æ–‡ä»¶ I/O |

âœ… **æ€»ç»“**ï¼š
- **`ThreadPoolExecutor`** é€‚ç”¨äº **I/O å¯†é›†ä»»åŠ¡**ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰ã€‚
- **`ProcessPoolExecutor`** é€‚ç”¨äº **CPU å¯†é›†ä»»åŠ¡**ï¼ˆå¦‚æ•°å­¦è®¡ç®—ã€å¤§æ•°æ®å¤„ç†ï¼‰ã€‚

---

### **3ï¸âƒ£ I/O å¯†é›† vs. CPU å¯†é›†ä»»åŠ¡**
å¹¶è¡Œè®¡ç®—æ˜¯å¦èƒ½æé«˜æ€§èƒ½ï¼Œå–å†³äºä»»åŠ¡ç±»å‹ï¼š

- **I/O å¯†é›†ä»»åŠ¡**ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ï¼‰
  - CPU ä¸»è¦åœ¨ç­‰å¾… I/O å®Œæˆï¼ŒGIL å¹¶ä¸ä¼šæˆä¸ºç“¶é¢ˆã€‚
  - **`ThreadPoolExecutor` æ›´åˆé€‚**ï¼Œå› ä¸º I/O çº¿ç¨‹ä¸ä¼šå— GIL é™åˆ¶ã€‚
  
- **CPU å¯†é›†ä»»åŠ¡**ï¼ˆå¦‚å¤§è§„æ¨¡è®¡ç®—ã€å›¾åƒå¤„ç†ï¼‰
  - è®¡ç®—å ç”¨ CPUï¼Œå— Python GIL é™åˆ¶ï¼Œçº¿ç¨‹æ— æ³•çœŸæ­£å¹¶è¡Œã€‚
  - **`ProcessPoolExecutor` æ›´åˆé€‚**ï¼Œå› ä¸ºå¤šä¸ªè¿›ç¨‹å¯ä»¥ç»•è¿‡ GILã€‚

âœ… **å¦‚ä½•åˆ¤æ–­ä»»åŠ¡ç±»å‹ï¼Ÿ**
```python
import time
from concurrent.futures import ThreadPoolExecutor, ProcessPoolExecutor

def io_task(n):
    time.sleep(n)  # æ¨¡æ‹Ÿ I/O ç­‰å¾…
    return f"I/O ä»»åŠ¡ {n} å®Œæˆ"

def cpu_task(n):
    total = sum(i**2 for i in range(10**6))  # å¤§é‡è®¡ç®—
    return f"CPU ä»»åŠ¡ {n} è®¡ç®—å®Œæˆ"

# è¿è¡Œæµ‹è¯•
start = time.time()
with ThreadPoolExecutor() as executor:
    list(executor.map(io_task, [1, 1, 1]))
print(f"I/O ä»»åŠ¡è€—æ—¶: {time.time() - start:.2f}s")

start = time.time()
with ProcessPoolExecutor() as executor:
    list(executor.map(cpu_task, [1, 1, 1]))
print(f"CPU ä»»åŠ¡è€—æ—¶: {time.time() - start:.2f}s")
```
ğŸ“Œ **ç»“æœç¤ºä¾‹**ï¼š
```
I/O ä»»åŠ¡è€—æ—¶: 1.17s
CPU ä»»åŠ¡è€—æ—¶: 2.84s
```
ğŸ‘‰ I/O ä»»åŠ¡æ¯” CPU ä»»åŠ¡æ›´é€‚åˆç”¨å¤šçº¿ç¨‹å¤„ç†ã€‚

---

### **4ï¸âƒ£ `as_completed()` åœ¨å¹¶è¡Œè®¡ç®—ä¸­çš„åº”ç”¨**

**ğŸŒŸ `as_completed()` çš„ä½œç”¨**
- é€‚ç”¨äº **`ThreadPoolExecutor` å’Œ `ProcessPoolExecutor`**ã€‚
- **æŒ‰ä»»åŠ¡å®Œæˆçš„é¡ºåºè¿”å›ç»“æœ**ï¼Œæé«˜ååé‡ã€‚

#### **ğŸš€ `map()` vs. `as_completed()`**
##### **ğŸ”¹ `map()`ï¼ˆæŒ‰æäº¤é¡ºåºè¿”å›ï¼‰**
```python
from concurrent.futures import ThreadPoolExecutor
import time

def task(n):
    time.sleep(n)
    return f"Task {n} done!"

with ThreadPoolExecutor(max_workers=3) as executor:
    results = list(executor.map(task, [3, 2, 1]))
    print(results)
```
ğŸ“Œ **è¾“å‡ºï¼ˆå›ºå®šé¡ºåºï¼‰**ï¼š
```
['Task 3 done!', 'Task 2 done!', 'Task 1 done!']
```
âŒ **é—®é¢˜**ï¼šæ…¢ä»»åŠ¡æ‹–ç´¯å¿«ä»»åŠ¡ã€‚

##### **ğŸ”¹ `as_completed()`ï¼ˆæŒ‰å®Œæˆé¡ºåºè¿”å›ï¼‰**
```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import time

def task(n):
    time.sleep(n)
    return f"Task {n} done!"

with ThreadPoolExecutor(max_workers=3) as executor:
    futures = {executor.submit(task, i): i for i in [3, 2, 1]}
    for future in as_completed(futures):
        print(future.result())
```
ğŸ“Œ **å¯èƒ½çš„è¾“å‡º**ï¼š
```
Task 1 done!
Task 2 done!
Task 3 done!
```
ğŸš€ **ä¼˜åŠ¿**ï¼šå¿«é€Ÿä»»åŠ¡ä¸è¢«æ…¢ä»»åŠ¡é˜»å¡ï¼Œæé«˜ååé‡ï¼

---

### **5ï¸âƒ£ `ProcessPoolExecutor` å¹¶è¡Œ `pysam` è¯»å– BAM**
```python
from concurrent.futures import ProcessPoolExecutor, as_completed
import pysam
import time

BAM_PATH = "your_data.bam"

def process_chromosome(chrom):
    start_time = time.time()
    with pysam.AlignmentFile(BAM_PATH, "rb") as bam:
        count = sum(1 for _ in bam.fetch(chrom))
    end_time = time.time()
    return f"âœ… {chrom}: {count} reads processed in {end_time - start_time:.2f}s"

if __name__ == "__main__":
    chromosomes = ["chr1", "chr2", "chr3"]
    with ProcessPoolExecutor(max_workers=3) as executor:
        futures = {executor.submit(process_chromosome, chrom): chrom for chrom in chromosomes}
        for future in as_completed(futures):
            print(future.result())
```
ğŸ“Œ **å‡è®¾ `chr3` ä»»åŠ¡æœ€è½»ï¼Œæœ€å¿«å®Œæˆ**ï¼š
```
âœ… chr3: 100000 reads processed in 2.31s
âœ… chr1: 500000 reads processed in 5.67s
âœ… chr2: 400000 reads processed in 6.12s
```
ğŸš€ **ä¼˜åŠ¿**ï¼šå…ˆå®Œæˆçš„ä»»åŠ¡å…ˆè¿”å›ï¼Œæé«˜æ•ˆç‡ï¼

---

### **6ï¸âƒ£ æ€»ç»“**
âœ… **GIL é™åˆ¶ Python çº¿ç¨‹çš„å¹¶è¡Œè®¡ç®—ï¼Œä½†å¯ä»¥ç”¨å¤šè¿›ç¨‹ç»•è¿‡** ğŸ”¥  
âœ… **`ThreadPoolExecutor` é€‚ç”¨äº I/O å¯†é›†ä»»åŠ¡ï¼Œ`ProcessPoolExecutor` é€‚ç”¨äº CPU å¯†é›†ä»»åŠ¡** ğŸ¯  
âœ… **`as_completed()` è®©ä»»åŠ¡æŒ‰å®Œæˆé¡ºåºè¿”å›ï¼Œæé«˜ååé‡** ğŸš€  
âœ… **å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç† `pysam`ï¼ŒåŠ å¿« BAM åˆ†æé€Ÿåº¦** ğŸ‰  

